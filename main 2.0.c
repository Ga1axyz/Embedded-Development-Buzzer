#include "sys.h"
#include "delay.h"
#include "timer.h"
#include "bz.h"
#include "key.h"
#include "led.h"

// Reference:  https://www.cnblogs.com/hicjiajia/archive/2012/03/31/2426339.html

u8 music[] ={    				//音乐代码，歌曲为《这世界那么多人》，格式为: 音符, 节拍, 音符, 节拍,    no sustain -

0x88,0x20,	0x88,0x20,	0x88,0x20,

0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x22,0x20,  0x23,0x10,  0x25,0x10,  0x23,0x20,
0x88,0x20,	0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,  0x16,0x10,  0x21,0x20,  0x16,0x10,	0x15,0x20,
0x88,0x20,	0x88,0x20,
0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x22,0x20,  0x23,0x10,  0x25,0x10,  0x26,0x20,	0x25,0x10,
0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x15,0x20,  0x16,0x20,  0x21,0x20,
	
0x88,0x20,	0x88,0x20,	0x88,0x10,

0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x22,0x20,  0x23,0x10,  0x25,0x10,  0x23,0x20,
0x88,0x20,	0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,  0x16,0x10,  0x21,0x20,  0x16,0x10,	0x15,0x20,
0x88,0x20,	0x88,0x20,
0x15,0x10,  0x21,0x20,  0x21,0x20,  0x21,0x10,  0x22,0x10,  0x23,0x10,  0x25,0x10,  0x26,0x20,  0x25,0x10,
0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x15,0x10,  0x15,0x10,  0x22,0x20,	0x21,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x25,0x20,  0x22,0x10,  0x23,0x20,  0x23,0x10,  0x22,0x10,  0x21,0x20,  0x22,0x20,  0x25,0x20,
0x88,0x20,
0x26,0x20,  0x31,0x10,  0x26,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x10,  0x21,0x10,  0x16,0x20,	0x25,0x20,  0x22,0x20,
0x88,0x10,
0x23,0x10,  0x22,0x10,  0x21,0x20,  0x22,0x20,  0x25,0x20,
0x88,0x20,
0x21,0x10,  0x26,0x10,  0x26,0x10,  0x31,0x10,  0x23,0x20,
0x88,0x10,
0x25,0x10,  0x23,0x10,  0x22,0x20,
0x88,0x10,
0x21,0x10,  0x22,0x10,  0x23,0x10,	0x26,0x20,  0x25,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,	0x26,0x10,  0x25,0x20,
0x88,0x20,
0x26,0x20,  0x25,0x10,  0x23,0x10,  0x22,0x20,  0x21,0x20,  0x16,0x10,  0x21,0x10,  0x25,0x10,	0x23,0x10,  0x22,0x20,
0x88,0x20,
0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,	0x32,0x10,  0x31,0x20,
0x88,0x20,
0x31,0x10,  0x26,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,	0x25,0x10,  0x23,0x10,	0x22,0x20,  0x21,0x10,  0x21,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x20,

0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x22,0x20,  0x23,0x10,  0x25,0x10,  0x23,0x20,
0x88,0x20,	0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,  0x16,0x10,  0x21,0x20,  0x16,0x10,	0x15,0x20,
0x88,0x20,	0x88,0x20,
0x15,0x10,  0x21,0x20,  0x21,0x20,  0x21,0x10,  0x22,0x10,  0x23,0x10,  0x25,0x10,  0x26,0x20,  0x25,0x10,
0x88,0x20,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x15,0x10,  0x15,0x10,  0x22,0x20,	0x21,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x25,0x20,  0x22,0x10,  0x23,0x20,  0x23,0x10,  0x22,0x10,  0x21,0x20,  0x22,0x20,  0x25,0x20,
0x88,0x20,
0x26,0x20,  0x31,0x10,  0x26,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x10,  0x21,0x10,  0x16,0x20,	0x25,0x20,  0x22,0x20,
0x88,0x10,
0x23,0x10,  0x22,0x10,  0x21,0x20,  0x22,0x20,  0x25,0x20,
0x88,0x20,
0x21,0x10,  0x26,0x10,  0x26,0x10,  0x31,0x10,  0x23,0x20,
0x88,0x10,
0x25,0x10,  0x23,0x10,  0x22,0x20,
0x88,0x10,
0x21,0x10,  0x22,0x10,  0x23,0x10,	0x26,0x20,  0x25,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,	0x26,0x10,  0x25,0x20,
0x88,0x20,
0x26,0x20,  0x25,0x10,  0x23,0x10,  0x22,0x20,  0x21,0x20,  0x16,0x10,  0x21,0x10,  0x25,0x10,	0x23,0x10,  0x22,0x20,
0x88,0x20,
0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,	0x32,0x10,  0x31,0x20,
0x88,0x20,
0x31,0x10,  0x26,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,	0x25,0x10,  0x23,0x10,	0x22,0x20,  0x21,0x10,  0x21,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,  0x26,0x10,  0x25,0x20,
0x88,0x20,
0x26,0x20,  0x25,0x10,  0x23,0x10,  0x22,0x20,  0x21,0x20,  0x16,0x10,  0x21,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x20,
0x88,0x20,
0x23,0x20,  0x25,0x10,  0x31,0x10,  0x32,0x20,  0x33,0x20,  0x21,0x10,  0x23,0x10,  0x31,0x10,  0x32,0x10,  0x31,0x20,
0x88,0x20,
0x31,0x10,  0x26,0x10,  0x25,0x10,  0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,  0x25,0x10,  0x23,0x10,	0x22,0x20,  0x21,0x10,  0x21,0x20,

0x88,0x20,	0x88,0x20,	0x88,0x10,

0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x22,0x20,  0x23,0x10,  0x25,0x10,  0x23,0x20,
0x88,0x20,	0x88,0x10,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x21,0x10,  0x16,0x10,  0x21,0x20,  0x16,0x10,	0x15,0x20,
0x88,0x20,	0x88,0x20,
0x15,0x10,  0x21,0x20,  0x21,0x10,  0x21,0x10,  0x21,0x10,	0x22,0x10,  0x23,0x10,  0x25,0x10,  0x26,0x20,  0x25,0x10,
0x88,0x10,
0x23,0x10,  0x22,0x10,  0x21,0x20,
0x88,0x10,
0x16,0x10,  0x15,0x20,  0x16,0x10,  0x21,0x10,	0x21,0x20,

0x00,0x00,0xff

};

u16 tune[] ={	  //此数组数据为各个音符在定时器中的重装值，第一列是高位，第二列是低位
		0xF922 ,	  //低八度，低1
		0xF9E2,	  
		0xFA8C,	  	//低3
		0xFAD9,
		0xFB69,	  	//低5
		0xFBE9,
		0xFC5C,	  	//低7	
	
		0xFC8F,	  	//中央 C 调
		0xFCF0,	  	//中2
		0xFD46,
		0xFD6D,	  	//中4
		0xFDB5,
		0xFDF5,	  	//中6
		0xFE2E,
	
		0xFE48,	  	//高八度，高1	
		0xFE79,
		0xFEA3,	  	//高3
		0xFEB7,
		0xFEDB,	  	//高5
		0xFEFB,
		0xFF16	  	//高7
};

int main( void )
{
 	u8 p, m, tem, pos;									// m为节拍
 	u32 i = 0;
	Stm32_Clock_Init( 6 );							// 6倍频
	delay_init( 72 );										// 12M外部晶振
	KeyInit();
	BzInit();
	Timer3Init( 71 );										// 1M
	LED_Init();
	LED_SEL = 0;
	
	while( 1 )
	{
		
		p = music[i];
		if( p==0x00 )											// 如果碰到结束符，延时1秒,回到开始再来一遍
		{
			i = 0;
			TIM3->CR1&= ~(0x01);						// 关闭定时器3
		}
		else if( p==0xff )								// 若碰到休止符,延时100ms,继续取下一音符
		{
			i = i + 2;
			delay_ms(100);
			TIM3->CR1&= ~(0x01);						// 关闭定时器3
		}
		else															// 正常情况下取音符和节拍 
		{
			if(p != 0x88){
				tem = QuYin( music[i] ); 			// 取出当前音符在quzi数组中的位置值
				TIM3->ARR = 0xffff - tune[tem]; 	
			}
			else{
				TIM3->ARR = 0;
			}
			i++;
			m = music[i]; 									// 取得节拍
			i++;
			delay_ms(62);
		}
		TIM3->CR1 |= 0x01;								// 使能定时器3
		
		pos = p;
		p &= 0xf;
		pos /= 16;
		if( pos == 8 )
			pos = 7;
		else
			pos = 8-pos;
		
		SetLed(pos,p);									// 数码管 闪烁相应的简谱
		
		delay_ms(m*24);
		TIM3->CR1 &=  ~(0x01);					//关闭定时器3
	}
}


